<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.org">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="../static/fancy.css">
<TITLE>分布式长连接聊天室</TITLE>
</HEAD><BODY BGCOLOR="white" TEXT="black">
<CENTER>
<H1>分布式长连接聊天室</H1>
<FONT SIZE="4"><I>作者: roy@rootk.com</I></FONT><BR>
<FONT SIZE="4">2013/03/09</FONT>
</CENTER>

<P></P>
<HR NOSHADE SIZE=1>
<P></P>

  <UL>
  <LI><A HREF="#toc1">1. 项目介绍</A>
  <LI><A HREF="#toc2">2. 结构图</A>
    <UL>
    <LI><A HREF="#toc3">2.1. 物理结构</A>
    <LI><A HREF="#toc4">2.2. 逻辑模块</A>
    </UL>
  <LI><A HREF="#toc5">3. 结构说明</A>
    <UL>
    <LI><A HREF="#toc6">3.1. WEB接口</A>
    <LI><A HREF="#toc7">3.2. 进程内存</A>
    <LI><A HREF="#toc8">3.3. UDP多播</A>
    <LI><A HREF="#toc9">3.4. Redis</A>
    </UL>
  <LI><A HREF="#toc10">4. 功能截图</A>
    <UL>
    <LI><A HREF="#toc11">4.1. 主界面</A>
    <LI><A HREF="#toc12">4.2. 大厅</A>
    <LI><A HREF="#toc13">4.3. 聊天房间</A>
    </UL>
  <LI><A HREF="#toc14">5. 目前应用</A>
  </UL>

<P></P>
<HR NOSHADE SIZE=1>
<P></P>

<A NAME="toc1"></A>
<H1>1. 项目介绍</H1>

<OL>
<LI>分布式架构，多个节点负载均衡
<LI>AJAX长连接，用户浏览器可实时得到消息
<LI>为在节点间实时传递用户状态，节点间UDP多播通讯
<LI>UDP多播使用Tornado的IOLOOP事件循环管理
<LI>使用Redis保存用户的消息缓存和全局信息
<LI>使用Tornado作为WEB服务器，支持同步和异步调用
<LI>最前端使用NGINX做多个服务器的HTTP负载均衡，使用keepalive机制和后端Tornado服务器连接
</OL>

<A NAME="toc2"></A>
<H1>2. 结构图</H1>

<A NAME="toc3"></A>
<H2>2.1. 物理结构</H2>

<P>
<IMG ALIGN="middle" SRC="/static/images/multiuser_chat/multiuser_chat.jpeg" BORDER="0" ALT="">
</P>

<A NAME="toc4"></A>
<H2>2.2. 逻辑模块</H2>

<P>
<IMG ALIGN="middle" SRC="/static/images/multiuser_chat/multiuser_chat_detail.jpeg" BORDER="0" ALT="">
</P>

<A NAME="toc5"></A>
<H1>3. 结构说明</H1>

<A NAME="toc6"></A>
<H2>3.1. WEB接口</H2>

<OL>
<LI>/api/new_message作为用户发送新消息的接口，同步的POST方法
<LI>/api/pool_message，长连接API，异步POST方法。作为和服务器通讯的主要接口
<LI>维护和释放本地进程的长连接
<LI>用户登入和登出的动作处理：通过异步连接通知本进程内的用户，并使用多播通知其他服务器
<LI>客户端浏览器关闭、刷新、或同一个用户多处登录处理
<LI>提供查看整个服务器内部状态的接口，方便管理
</OL>

<A NAME="toc7"></A>
<H2>3.2. 进程内存</H2>

<OL>
<LI>长连接对象为python对象，在服务器生命周期内必须保存在内存中
<LI>由于长连接对象保存在本地，作为将用户和长连接绑定的机制，一部分用户信息也保存在本地进程中
<LI>每个服务器进程中还有房间信息，这些房间保存了用户和长连接对象
</OL>

<A NAME="toc8"></A>
<H2>3.3. UDP多播</H2>

<OL>
<LI>由于需要实时的通知本服务器进程内用户/房间的变化，必须使用一种实时高效的机制通知其他服务器
<LI>需要通知其他服务器的消息有，广播消息、普通聊天消息（当用户不在本地进程时）、私聊消息、用户上线下线通知、命令广播（创建/删除房间等）
</OL>

<A NAME="toc9"></A>
<H2>3.4. Redis</H2>

<OL>
<LI>基于内存的noSQL服务器，Redis保存了聊天消息缓存
<LI>由于本地进程只保存了非常有限的用户信息，用户的详细信息也保存在Redis中
<LI>房间列表（包括房间内的用户）同样保存在Redis中
<LI>将这些数据保存在Redis中的原因是，在分布式架构中方便任意服务器访问/修改
</OL>

<A NAME="toc10"></A>
<H1>4. 功能截图</H1>

<A NAME="toc11"></A>
<H2>4.1. 主界面</H2>

<P>
<IMG ALIGN="middle" SRC="/static/images/multiuser_chat/main.jpg" BORDER="0" ALT="">
</P>

<A NAME="toc12"></A>
<H2>4.2. 大厅</H2>

<P>
<IMG ALIGN="middle" SRC="/static/images/multiuser_chat/lobby.jpg" BORDER="0" ALT="">
</P>

<A NAME="toc13"></A>
<H2>4.3. 聊天房间</H2>

<P>
<IMG ALIGN="middle" SRC="/static/images/multiuser_chat/chatroom.jpg" BORDER="0" ALT="">
</P>

<A NAME="toc14"></A>
<H1>5. 目前应用</H1>

<P>
<A HREF="http://chat.rootk.com">http://chat.rootk.com</A>
</P>

<!-- html code generated by txt2tags 2.6 (http://txt2tags.org) -->
<!-- cmdline: txt2tags index.t2t -->
</BODY></HTML>
